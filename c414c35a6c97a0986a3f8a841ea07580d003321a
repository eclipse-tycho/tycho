{
  "comments": [
    {
      "key": {
        "uuid": "51eae69d_7d856560",
        "filename": "tycho-bundles/org.eclipse.tycho.p2.maven.repository/src/main/java/org/eclipse/tycho/repository/p2base/artifact/repository/ArtifactRepositoryBaseImpl.java",
        "patchSetId": 1
      },
      "lineNbr": 72,
      "author": {
        "id": 171685
      },
      "writtenOn": "2020-11-09T13:25:07Z",
      "side": 1,
      "message": "I for concurrency the descriptors+descriptorsMap should be merged into one, then all the synchronized methods can be omitted and replaced with basic atomic map operations. This would also remove the need to keep both in sync.",
      "revId": "c414c35a6c97a0986a3f8a841ea07580d003321a",
      "serverId": "97ee7c02-f12f-4043-b43e-dea463d88b31",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "f73a59ec_276b032a",
        "filename": "tycho-bundles/org.eclipse.tycho.p2.maven.repository/src/main/java/org/eclipse/tycho/repository/p2base/artifact/repository/ArtifactRepositoryBaseImpl.java",
        "patchSetId": 1
      },
      "lineNbr": 72,
      "author": {
        "id": 101744
      },
      "writtenOn": "2020-11-09T13:32:48Z",
      "side": 1,
      "message": "How? You have \n1) regular map access - can be made atomic\n2) write access to the map\u0027s values - maybe with a CopyOnWrite set instead of the hashset, would lose performance though\n3) values().contains(descriptor) - would no longer be O(1)",
      "parentUuid": "51eae69d_7d856560",
      "revId": "c414c35a6c97a0986a3f8a841ea07580d003321a",
      "serverId": "97ee7c02-f12f-4043-b43e-dea463d88b31",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "3133ba3c_3677ce73",
        "filename": "tycho-bundles/org.eclipse.tycho.p2.maven.repository/src/main/java/org/eclipse/tycho/repository/p2base/artifact/repository/ArtifactRepositoryBaseImpl.java",
        "patchSetId": 1
      },
      "lineNbr": 72,
      "author": {
        "id": 171685
      },
      "writtenOn": "2020-11-10T08:09:45Z",
      "side": 1,
      "message": "First about the easy part: \"contains no longer be O(1)\", I think that is not a problem unless we can prove that this method is actually called very often, and if we are concerned about parallelism I think this can be replaced by:\n\ndescriptorsMap.entrySet().parallelStream().unordered().anyMatch(e-\u003ee.getValue().contains(descriptor));\n\neven though I generally try to avoid to use parallel streams in trivial operations.\n-----------\ndescriptorQueryable can be replaced by \n(query, monitor) -\u003e query.perform((Iterator\u003cIArtifactDescriptor\u003e) descriptorsMap.entrySet().stream().unordered().flatMap(e-\u003ee.getValue().stream()).iterator());\n\nthen all other access to descriptors can be omited.\n------------\n\ninitDescriptorsMapEntry can essentially be replaced by computeIfAbsent using ConcurrentHashMap.newKeySet() for a concurrent aware set, we can throw away the\n\nif (descriptorsForKey.isEmpty()) {\n   descriptorsMap.remove(artifactKey);\n}",
      "parentUuid": "f73a59ec_276b032a",
      "revId": "c414c35a6c97a0986a3f8a841ea07580d003321a",
      "serverId": "97ee7c02-f12f-4043-b43e-dea463d88b31",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "1bad7640_2e57d290",
        "filename": "tycho-bundles/org.eclipse.tycho.p2.maven.repository/src/main/java/org/eclipse/tycho/repository/p2base/artifact/repository/ArtifactRepositoryBaseImpl.java",
        "patchSetId": 1
      },
      "lineNbr": 72,
      "author": {
        "id": 171685
      },
      "writtenOn": "2020-11-10T08:18:31Z",
      "side": 1,
      "message": "Maybe ConcurrentSkipListSet would even be better suited here as it seems the code is creating \"compareable\" versions anyways?\n\nThis would require to change the generic parameter in the following way:\nArtifactRepositoryBaseImpl\u003cArtifactDescriptorT extends IArtifactDescriptor \u0026 Comparable\u003cArtifactDescriptorT\u003e\u003e",
      "parentUuid": "3133ba3c_3677ce73",
      "revId": "c414c35a6c97a0986a3f8a841ea07580d003321a",
      "serverId": "97ee7c02-f12f-4043-b43e-dea463d88b31",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "e94d554a_52c71e51",
        "filename": "tycho-bundles/org.eclipse.tycho.p2.maven.repository/src/main/java/org/eclipse/tycho/repository/p2base/artifact/repository/ArtifactRepositoryBaseImpl.java",
        "patchSetId": 1
      },
      "lineNbr": 72,
      "author": {
        "id": 101744
      },
      "writtenOn": "2020-11-10T13:11:56Z",
      "side": 1,
      "message": "Done. I concede that this didn\u0027t make the code terribly complicated ;)\n\nI didn\u0027t get the ConcurrentSkipListSet part though. The getComparableDescriptor doesn\u0027t relate to j.l.Comparable.",
      "parentUuid": "1bad7640_2e57d290",
      "revId": "c414c35a6c97a0986a3f8a841ea07580d003321a",
      "serverId": "97ee7c02-f12f-4043-b43e-dea463d88b31",
      "unresolved": false
    }
  ]
}